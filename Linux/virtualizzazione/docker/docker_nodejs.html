<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
    <head>
        <meta charset="utf-8" />
        <meta name="generator" content="markdown-it" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
        <meta name="author" content="runner" />
        <meta name="dcterms.date" content="2025-04-09 13:28:33.863" />
        <title>docker_nodejs</title>
        <style type="text/css">
            code {
                white-space: pre-wrap;
            }
            span.smallcaps {
                font-variant: small-caps;
            }
            span.underline {
                text-decoration: underline;
            }
            div.column {
                display: inline-block;
                vertical-align: top;
                width: 50%;
            }
        </style>
        <style type="text/css">
            a.sourceLine {
                display: inline-block;
                line-height: 1.25;
            }
            a.sourceLine {
                pointer-events: none;
                color: inherit;
                text-decoration: inherit;
            }
            a.sourceLine:empty {
                height: 1.2em;
            }
            .sourceCode {
                overflow: visible;
            }
            code.sourceCode {
                white-space: pre;
                position: relative;
            }
            div.sourceCode {
                margin: 1em 0;
            }
            pre.sourceCode {
                margin: 0;
            }
            @media screen {
                div.sourceCode {
                    overflow: auto;
                }
            }
            @media print {
                code.sourceCode {
                    white-space: pre-wrap;
                }
                a.sourceLine {
                    text-indent: -1em;
                    padding-left: 1em;
                }
            }
            pre.numberSource a.sourceLine {
                position: relative;
                left: -4em;
            }
            pre.numberSource a.sourceLine::before {
                content: attr(title);
                position: relative;
                left: -1em;
                text-align: right;
                vertical-align: baseline;
                border: none;
                pointer-events: all;
                display: inline-block;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                padding: 0 4px;
                width: 4em;
                background-color: #ffffff;
                color: #a0a0a0;
            }
            pre.numberSource {
                margin-left: 3em;
                border-left: 1px solid #a0a0a0;
                padding-left: 4px;
            }
            div.sourceCode {
                color: #1f1c1b;
                background-color: #ffffff;
            }
            @media screen {
                a.sourceLine::before {
                    text-decoration: underline;
                }
            }
            code span {
                color: #1f1c1b;
            } /* Normal */
            code span.al {
                color: #bf0303;
                background-color: #f7e6e6;
                font-weight: bold;
            } /* Alert */
            code span.an {
                color: #ca60ca;
            } /* Annotation */
            code span.at {
                color: #0057ae;
            } /* Attribute */
            code span.bn {
                color: #b08000;
            } /* BaseN */
            code span.bu {
                color: #644a9b;
                font-weight: bold;
            } /* BuiltIn */
            code span.cf {
                color: #1f1c1b;
                font-weight: bold;
            } /* ControlFlow */
            code span.ch {
                color: #924c9d;
            } /* Char */
            code span.cn {
                color: #aa5500;
            } /* Constant */
            code span.co {
                color: #898887;
            } /* Comment */
            code span.cv {
                color: #0095ff;
            } /* CommentVar */
            code span.do {
                color: #607880;
            } /* Documentation */
            code span.dt {
                color: #0057ae;
            } /* DataType */
            code span.dv {
                color: #b08000;
            } /* DecVal */
            code span.er {
                color: #bf0303;
                text-decoration: underline;
            } /* Error */
            code span.ex {
                color: #0095ff;
                font-weight: bold;
            } /* Extension */
            code span.fl {
                color: #b08000;
            } /* Float */
            code span.fu {
                color: #644a9b;
            } /* Function */
            code span.im {
                color: #ff5500;
            } /* Import */
            code span.in {
                color: #b08000;
            } /* Information */
            code span.kw {
                color: #1f1c1b;
                font-weight: bold;
            } /* Keyword */
            code span.op {
                color: #1f1c1b;
            } /* Operator */
            code span.ot {
                color: #006e28;
            } /* Other */
            code span.pp {
                color: #006e28;
            } /* Preprocessor */
            code span.re {
                color: #0057ae;
                background-color: #e0e9f8;
            } /* RegionMarker */
            code span.sc {
                color: #3daee9;
            } /* SpecialChar */
            code span.ss {
                color: #ff5500;
            } /* SpecialString */
            code span.st {
                color: #bf0303;
            } /* String */
            code span.va {
                color: #0057ae;
            } /* Variable */
            code span.vs {
                color: #bf0303;
            } /* VerbatimString */
            code span.wa {
                color: #bf0303;
            } /* Warning */
        </style>
        <!--
  Firefox non carica font da locale quindi il font puÃ² non essere visibile
  quando di carica la pagina da locale.
  Bisogna impostare about:config
    security.fileuri.strict_origin_policy = false
  -->
        <link rel="stylesheet" href="../../../inc/css/katex.min.css" />
        <link rel="stylesheet" href="../../../inc/css/fonts/google_fonts.css" />
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous"> -->
        <link rel="stylesheet" href="../../../inc/css/bootstrap.min.css" />
        <link rel="stylesheet" href="../../../inc/css/cdp.css" />
        <!--[if lt IE 9]>
            <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <![endif]-->
        <meta name="keywords" content="Appunti,Note" />
        <meta name="description" content="Appunti di runner" />
        <link rel="icon" type="image/x-icon" href="../../../inc/img/favicon.ico" />
        <link rel="shortcut icon" type="image/x-icon" href="../../../inc/img/favicon.ico" />

        <link rel="stylesheet" href="../../../inc/js/hljs/styles/default.css" />
        <script src="../../../inc/js/hljs/lib/highlight.js"></script>
        <script src="../../../inc/js/bootstrap/bootstrap.bundle.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script> -->
        <script>
            hljs.initHighlightingOnLoad();
        </script>
        <script type="module">
            import mermaid from '../../../inc/js/mermaid/dist/mermaid.esm.min.mjs';
            // import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
            mermaid.initialize({ startOnLoad: true });
        </script>
    </head>
    <body></body>
</html>
<h1 id="docker_nodejs" tabindex="-1">docker_nodejs <a class="header-anchor" href="#docker_nodejs" aria-hidden="true">ðŸ”—</a></h1>
<p class="code">2025-04-09 13:28:33.863</p>
<nav class="table-of-contents"><ol></ol></nav><h1 id="applicazioni-node.js-dockerizzate" tabindex="-1">Applicazioni Node.js dockerizzate <a class="header-anchor" href="#applicazioni-node.js-dockerizzate" aria-hidden="true">ðŸ”—</a></h1>
<ul>
<li>
<p><a href="https://hub.docker.com/_/node">https://hub.docker.com/_/node</a> Immagine Docker per Node.js basata su <code>Debian</code></p>
</li>
<li>
<p><a href="https://github.com/nodejs/docker-node/blob/main/README.md#how-to-use-this-image">https://github.com/nodejs/docker-node/blob/main/README.md#how-to-use-this-image</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/language/nodejs/">https://docs.docker.com/language/nodejs/</a></p>
</li>
<li>
<p><a href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/">https://nodejs.org/en/docs/guides/nodejs-docker-webapp/</a></p>
</li>
<li>
<p><a href="https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#docker-and-nodejs-best-practices">https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#docker-and-nodejs-best-practices</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleContainerTools/distroless/blob/main/examples/nodejs/Dockerfile">https://github.com/GoogleContainerTools/distroless/blob/main/examples/nodejs/Dockerfile</a></p>
<pre><code class="language-yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;2&quot;</span>
<span class="hljs-attr">services:</span>
<span class="hljs-attr">node:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">&quot;node:8&quot;</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">&quot;node&quot;</span>
    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/home/node/app</span>
    <span class="hljs-attr">environment:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">NODE_ENV=production</span>
    <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./:/home/node/app</span>
    <span class="hljs-attr">expose:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8081&quot;</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">&quot;npm start&quot;</span>
</code></pre>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<pre><code class="language-bash">$ docker run -it --<span class="hljs-built_in">rm</span> --name my-running-script -v <span class="hljs-string">&quot;<span class="hljs-variable">$PWD</span>&quot;</span>:/usr/src/app -w /usr/src/app node:16 node your-daemon-or-script.js
</code></pre>
</li>
<li>
<p><a href="https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#non-root-user">https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#non-root-user</a>
<a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user</a></p>
<p>By default, Docker runs commands inside the container as root which violates the Principle of Least Privilege (PoLP) when superuser permissions are not strictly required. You want to run the container as an unprivileged user whenever possible. <br>
The node images provide the <code>node</code> user for such purpose.</p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16</span>
...
<span class="hljs-comment"># At the end, set the user to use when running this image</span>
<span class="hljs-keyword">USER</span> node
</code></pre>
<p>If you need to change the uid/gid of the user you can use:</p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">RUN</span><span class="language-bash"> groupmod -g 999 node &amp;&amp; usermod -u 999 -g 999 node</span>
</code></pre>
</li>
<li>
<p><a href="https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#cmd">https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#cmd</a></p>
</li>
<li>
<p><a href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/">https://nodejs.org/en/docs/guides/nodejs-docker-webapp/</a></p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16</span>

<span class="hljs-comment"># Create app directory</span>
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /usr/src/app</span>

<span class="hljs-comment"># Install app dependencies</span>
<span class="hljs-comment"># A wildcard is used to ensure both package.json AND package-lock.json are copied</span>
<span class="hljs-comment"># where available (npm@5+)</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> package*.json ./</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> npm install</span>
<span class="hljs-comment"># If you are building your code for production</span>
<span class="hljs-comment"># RUN npm ci --only=production</span>

<span class="hljs-comment"># Bundle app source</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span>
<span class="hljs-keyword">CMD</span><span class="language-bash"> [ <span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;server.js&quot;</span> ]</span>
</code></pre>
<p><code>.dockerignore</code></p>
<pre><code>  node_modules
  npm-debug.log
</code></pre>
</li>
<li>
<p><a href="https://docs.docker.com/language/nodejs/build-images/#create-a-dockerfile-for-nodejs">https://docs.docker.com/language/nodejs/build-images/#create-a-dockerfile-for-nodejs</a></p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">12.18</span>.<span class="hljs-number">1</span>
<span class="hljs-keyword">ENV</span> NODE_ENV=production
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> [<span class="hljs-string">&quot;package.json&quot;</span>, <span class="hljs-string">&quot;package-lock.json*&quot;</span>, <span class="hljs-string">&quot;./&quot;</span>]</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> npm install --production</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>
<span class="hljs-keyword">CMD</span><span class="language-bash"> [ <span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;server.js&quot;</span> ]    </span>
</code></pre>
</li>
<li>
<p><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#run">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#run</a></p>
<p>Always combine <code>RUN apt-get update</code> with <code>apt-get install</code> in the same RUN statement.
Using <code>apt-get update</code> alone in a RUN statement causes caching issues and subsequent <code>apt-get install</code> instructions fail.
Questo perchÃ¨ il layer creato da <code>apt-get update</code> viene messo in cache e non cambia mai perchÃ¨ l'istruzione <code>apt-get update</code> non cambia,
la install seguente vedrÃ  dunque sempre i pacchetti vecchi.
Using <code>RUN apt-get update &amp;&amp; apt-get install -y</code> ensures your Dockerfile installs the latest package versions with no further coding or manual intervention. This technique is known as <strong><code>cache busting</code></strong>.
Usando una unica istruzione contenente anche i nomi dei pacchetti, se un pacchetto cambia la riga <code>RUN</code> cambia e la cache viene invalidata, ricreando il layer.</p>
</li>
<li>
<p><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#sort-multi-line-arguments">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#sort-multi-line-arguments</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/61990329/dockerfile-benefits-of-repeated-apt-cache-cleans">https://stackoverflow.com/questions/61990329/dockerfile-benefits-of-repeated-apt-cache-cleans</a></p>
<p>Avere tutto in un unica riga non solo crea un solo layer, ma lo mantiene di dimensioni ridotte a causa della rimozione dei file non utili.</p>
<pre><code class="language-Dockerfile"><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \
bzr \
cvs \
git \
mercurial \
subversion \
&amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/apt/lists/*</span>
</code></pre>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/27701930/how-to-add-users-to-docker-container">https://stackoverflow.com/questions/27701930/how-to-add-users-to-docker-container</a></p>
<pre><code>  RUN useradd -ms /bin/bash newuser
  USER newuser
  WORKDIR /home/newuser

  RUN useradd -rm -d /home/ubuntu -s /bin/bash -g root -G sudo -u 1001 ubuntu
  USER ubuntu
  WORKDIR /home/ubuntu
</code></pre>
</li>
<li>
<p><a href="https://man.archlinux.org/man/login.defs.5">https://man.archlinux.org/man/login.defs.5</a></p>
<pre><code>  L'id del primo utente creato nel Dockerfile dovrebbe essere `1000`, questo serve per dare i diritti
  sulle directory dell'host montate in bind mount.

  UID_MAX (number), UID_MIN (number)
  Range of user IDs used for the creation of regular users by useradd or newusers.
  The default value for UID_MIN (resp. UID_MAX) is 1000 
</code></pre>
</li>
<li>
<p><a href="https://man.archlinux.org/man/useradd.8">https://man.archlinux.org/man/useradd.8</a> per creare utenti nel Dockerfile</p>
<pre><code>  -u, --uid UID The numerical value of the user's ID. The default is to use the smallest ID value greater than or equal to UID_MIN and greater than every other user.
  -g, --gid GROUP The group name or number of the user's initial login group.
  -G, --groups GROUP1[,GROUP2,...[,GROUPN]]] A list of supplementary groups which the user is also a member of.
  -s, --shell SHELL The name of the user's login shell.
  -m, --create-home Create the user's home directory if it does not exist. 
  -d, --home-dir HOME_DIR The new user will be created using HOME_DIR as the value for the user's login directory. The default is to append the LOGIN name to BASE_DIR and use that as the login directory name.
  -r, --system Create a system account.
  -f, --inactive INACTIVE The number of days after a password expires until the account is permanently disabled.
</code></pre>
</li>
<li>
<p><a href="https://docs.docker.com/storage/bind-mounts/">https://docs.docker.com/storage/bind-mounts/</a></p>
<p>Utilizzando nel Dockerfile un <strong>utente non root</strong>, se si montano delle directory dell'host in bind mount, debbono essere dati su tali directories
gli opportuni diritti di accesso allo stesso UID del container.</p>
<pre><code class="language-dockerfile">    <span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -<span class="hljs-built_in">rm</span> -d /home/ubuntu -s /bin/bash -g root -G <span class="hljs-built_in">sudo</span> -u 1000 ubuntu</span>
    <span class="hljs-keyword">USER</span> ubuntu
    <span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /home/ubuntu</span>
</code></pre>
<pre><code class="language-bash">$ <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /opt/elastic_search_pwned/data
$ <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> -R 1000:0 /opt/elastic_search_pwned/
$ <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> -R :0 /opt/elastic_search_pwned/

$ <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> -R g+rwx /opt/elastic_search_pwned
<span class="hljs-comment"># Ensure all future content in the folder will inherit group ownership</span>
$ <span class="hljs-built_in">chmod</span> -R g+s /opt/elastic_search_pwned/

$ <span class="hljs-comment">#sudo chgrp 0 /opt/elastic_search_pwned/data</span>
$ <span class="hljs-built_in">sudo</span> usermod -aG 0 <span class="hljs-variable">$USER</span> <span class="hljs-comment"># aggiungo l&#x27;utente host al gruppo root</span>
</code></pre>
</li>
</ul>
</body></html>