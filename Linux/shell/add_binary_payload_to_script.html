<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
    <head>
        <meta charset="utf-8" />
        <meta name="generator" content="markdown-it" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
        <meta name="author" content="runner" />
        <meta name="dcterms.date" content="2025-04-08 13:44:53.085" />
        <title>add_binary_payload_to_script</title>
        <style type="text/css">
            code {
                white-space: pre-wrap;
            }
            span.smallcaps {
                font-variant: small-caps;
            }
            span.underline {
                text-decoration: underline;
            }
            div.column {
                display: inline-block;
                vertical-align: top;
                width: 50%;
            }
        </style>
        <style type="text/css">
            a.sourceLine {
                display: inline-block;
                line-height: 1.25;
            }
            a.sourceLine {
                pointer-events: none;
                color: inherit;
                text-decoration: inherit;
            }
            a.sourceLine:empty {
                height: 1.2em;
            }
            .sourceCode {
                overflow: visible;
            }
            code.sourceCode {
                white-space: pre;
                position: relative;
            }
            div.sourceCode {
                margin: 1em 0;
            }
            pre.sourceCode {
                margin: 0;
            }
            @media screen {
                div.sourceCode {
                    overflow: auto;
                }
            }
            @media print {
                code.sourceCode {
                    white-space: pre-wrap;
                }
                a.sourceLine {
                    text-indent: -1em;
                    padding-left: 1em;
                }
            }
            pre.numberSource a.sourceLine {
                position: relative;
                left: -4em;
            }
            pre.numberSource a.sourceLine::before {
                content: attr(title);
                position: relative;
                left: -1em;
                text-align: right;
                vertical-align: baseline;
                border: none;
                pointer-events: all;
                display: inline-block;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                padding: 0 4px;
                width: 4em;
                background-color: #ffffff;
                color: #a0a0a0;
            }
            pre.numberSource {
                margin-left: 3em;
                border-left: 1px solid #a0a0a0;
                padding-left: 4px;
            }
            div.sourceCode {
                color: #1f1c1b;
                background-color: #ffffff;
            }
            @media screen {
                a.sourceLine::before {
                    text-decoration: underline;
                }
            }
            code span {
                color: #1f1c1b;
            } /* Normal */
            code span.al {
                color: #bf0303;
                background-color: #f7e6e6;
                font-weight: bold;
            } /* Alert */
            code span.an {
                color: #ca60ca;
            } /* Annotation */
            code span.at {
                color: #0057ae;
            } /* Attribute */
            code span.bn {
                color: #b08000;
            } /* BaseN */
            code span.bu {
                color: #644a9b;
                font-weight: bold;
            } /* BuiltIn */
            code span.cf {
                color: #1f1c1b;
                font-weight: bold;
            } /* ControlFlow */
            code span.ch {
                color: #924c9d;
            } /* Char */
            code span.cn {
                color: #aa5500;
            } /* Constant */
            code span.co {
                color: #898887;
            } /* Comment */
            code span.cv {
                color: #0095ff;
            } /* CommentVar */
            code span.do {
                color: #607880;
            } /* Documentation */
            code span.dt {
                color: #0057ae;
            } /* DataType */
            code span.dv {
                color: #b08000;
            } /* DecVal */
            code span.er {
                color: #bf0303;
                text-decoration: underline;
            } /* Error */
            code span.ex {
                color: #0095ff;
                font-weight: bold;
            } /* Extension */
            code span.fl {
                color: #b08000;
            } /* Float */
            code span.fu {
                color: #644a9b;
            } /* Function */
            code span.im {
                color: #ff5500;
            } /* Import */
            code span.in {
                color: #b08000;
            } /* Information */
            code span.kw {
                color: #1f1c1b;
                font-weight: bold;
            } /* Keyword */
            code span.op {
                color: #1f1c1b;
            } /* Operator */
            code span.ot {
                color: #006e28;
            } /* Other */
            code span.pp {
                color: #006e28;
            } /* Preprocessor */
            code span.re {
                color: #0057ae;
                background-color: #e0e9f8;
            } /* RegionMarker */
            code span.sc {
                color: #3daee9;
            } /* SpecialChar */
            code span.ss {
                color: #ff5500;
            } /* SpecialString */
            code span.st {
                color: #bf0303;
            } /* String */
            code span.va {
                color: #0057ae;
            } /* Variable */
            code span.vs {
                color: #bf0303;
            } /* VerbatimString */
            code span.wa {
                color: #bf0303;
            } /* Warning */
        </style>
        <!--
  Firefox non carica font da locale quindi il font puÃ² non essere visibile
  quando di carica la pagina da locale.
  Bisogna impostare about:config
    security.fileuri.strict_origin_policy = false
  -->
        <link rel="stylesheet" href="../../inc/css/katex.min.css" />
        <link rel="stylesheet" href="../../inc/css/fonts/google_fonts.css" />
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous"> -->
        <link rel="stylesheet" href="../../inc/css/bootstrap.min.css" />
        <link rel="stylesheet" href="../../inc/css/cdp.css" />
        <!--[if lt IE 9]>
            <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <![endif]-->
        <meta name="keywords" content="Appunti,Note" />
        <meta name="description" content="Appunti di runner" />
        <link rel="icon" type="image/x-icon" href="../../inc/img/favicon.ico" />
        <link rel="shortcut icon" type="image/x-icon" href="../../inc/img/favicon.ico" />

        <link rel="stylesheet" href="../../inc/js/hljs/styles/default.css" />
        <script src="../../inc/js/hljs/lib/highlight.js"></script>
        <script src="../../inc/js/bootstrap/bootstrap.bundle.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script> -->
        <script>
            hljs.initHighlightingOnLoad();
        </script>
        <script type="module">
            import mermaid from '../../inc/js/mermaid/dist/mermaid.esm.min.mjs';
            // import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
            mermaid.initialize({ startOnLoad: true });
        </script>
    </head>
    <body></body>
</html>
<h1 id="add_binary_payload_to_script" tabindex="-1">add_binary_payload_to_script <a class="header-anchor" href="#add_binary_payload_to_script" aria-hidden="true">ðŸ”—</a></h1>
<p class="code">2025-04-08 13:44:53.085</p>
<nav class="table-of-contents"><ol><li><a href="#makeself-e-shar">makeself e shar </a></li><li><a href="#addpayload">addpayload </a></li></ol></nav><h1 id="come-aggiungere-un-contenuto-binario-allo-script" tabindex="-1">Come aggiungere un contenuto binario allo script <a class="header-anchor" href="#come-aggiungere-un-contenuto-binario-allo-script" aria-hidden="true">ðŸ”—</a></h1>
<h2 id="makeself-e-shar" tabindex="-1">makeself e shar <a class="header-anchor" href="#makeself-e-shar" aria-hidden="true">ðŸ”—</a></h2>
<p>Vedere anche <code>makeself</code> e <code>shar</code>:</p>
<ul>
<li><a href="https://makeself.io/">https://makeself.io/</a></li>
<li><a href="http://www.gnu.org/software/sharutils/">http://www.gnu.org/software/sharutils/</a></li>
<li><a href="https://it.wikipedia.org/wiki/Shar_(Unix)">https://it.wikipedia.org/wiki/Shar_(Unix)</a></li>
</ul>
<pre><code class="language-bash"><span class="hljs-comment">#/usr/bin/env bash</span>
apt install sharutils
man shar
</code></pre>
<h2 id="addpayload" tabindex="-1">addpayload <a class="header-anchor" href="#addpayload" aria-hidden="true">ðŸ”—</a></h2>
<p>Generally when we think of shell scripts we think of editable text, but it's possible to add binary data to your shell script as well. In this case we're going to talk about adding a binary payload to the end of your shell script.</p>
<p>Adding a binary payload to a shell script could, for instance, be used to create a single file shell script that installs your entire software package which could be composed of hundreds of files. You merely append the tar or gzip file of your package as a binary payload to the script file, when the script runs it extracts the payload and does its task with the extracted files.</p>
<p>For this example I assume the appended file is a <code>tar.gz</code> file. The payload is appended to the end of an installation script preceded by a <strong>marker line (PAYLOAD:)</strong>. The appended data is either <strong>uuencoded</strong> or just binary data. The script that follows takes a single argument which should be the <code>tar.gz</code> to append to the installation script. The installation script template <code>install.sh.in</code> is copied to <code>install.sh</code> with the payload appended. This script is named <code>addpayload.sh</code> follows:</p>
<pre><code class="language-bash"><span class="hljs-comment">#/usr/bin/env bash</span>
<span class="hljs-comment"># addpayload.sh</span>
<span class="hljs-comment"># Check for payload format option (default is uuencode).</span>
uuencode=1
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> == <span class="hljs-string">&#x27;--binary&#x27;</span> ]]; <span class="hljs-keyword">then</span>
binary=1
uuencode=0
<span class="hljs-built_in">shift</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> == <span class="hljs-string">&#x27;--uuencode&#x27;</span> ]]; <span class="hljs-keyword">then</span>
binary=0
uuencode=1
<span class="hljs-built_in">shift</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ ! <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> ]]; <span class="hljs-keyword">then</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> [--binary | --uuencode] PAYLOAD_FILE&quot;</span>
<span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$binary</span> -ne 0 ]]; <span class="hljs-keyword">then</span>
<span class="hljs-comment"># Append binary data.</span>
sed \
-e <span class="hljs-string">&#x27;s/uuencode=./uuencode=0/&#x27;</span> \
-e <span class="hljs-string">&#x27;s/binary=./binary=1/&#x27;</span> \
install.sh.in &gt;install.sh
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;PAYLOAD:&quot;</span> &gt;&gt; install.sh
<span class="hljs-built_in">cat</span> <span class="hljs-variable">$1</span> &gt;&gt;install.sh
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$uuencode</span> -ne 0 ]]; <span class="hljs-keyword">then</span>
<span class="hljs-comment"># Append uuencoded data.</span>
sed \
-e <span class="hljs-string">&#x27;s/uuencode=./uuencode=1/&#x27;</span> \
-e <span class="hljs-string">&#x27;s/binary=./binary=0/&#x27;</span> \
install.sh.in &gt;install.sh
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;PAYLOAD:&quot;</span> &gt;&gt; install.sh
<span class="hljs-built_in">cat</span> <span class="hljs-variable">$1</span> | uuencode - &gt;&gt;install.sh
<span class="hljs-keyword">fi</span>
</code></pre>
<p>In addition to appending the payload it also modifies the installer script to tell it whether the payload is binary or uuencoded.</p>
<p>The template script <code>install.sh.in</code> is our installation script which at this point just untars the payload and nothing else.<br>
<strong>Actually, it doesn't even untar the payload it just tests it with tar's <code>-t</code> option</strong>:</p>
<pre><code class="language-bash"><span class="hljs-comment">#/usr/bin/env bash</span>
<span class="hljs-comment"># install.sh.in</span>
uuencode=1
binary=0
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">untar_payload</span></span>()
{
match=$(grep --text --line-number <span class="hljs-string">&#x27;^PAYLOAD:$&#x27;</span> <span class="hljs-variable">$0</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;:&#x27;</span> -f 1)
payload_start=$((match + <span class="hljs-number">1</span>))
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$binary</span> -ne 0 ]]; <span class="hljs-keyword">then</span>
<span class="hljs-built_in">tail</span> -n +<span class="hljs-variable">$payload_start</span> <span class="hljs-variable">$0</span> | tar -tzvf -
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$uuencode</span> -ne 0 ]]; <span class="hljs-keyword">then</span>
<span class="hljs-built_in">tail</span> -n +<span class="hljs-variable">$payload_start</span> <span class="hljs-variable">$0</span> | uudecode | tar -tzvf -
<span class="hljs-keyword">fi</span>
}
<span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;Install files? &quot;</span> ans
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">${ans:0:1}</span>&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">${ans:0:1}</span>&quot;</span> ]]; <span class="hljs-keyword">then</span>
untar_payload
<span class="hljs-comment"># Do remainder of install steps.</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre>
<p>In the function <code>untar_payload</code> the script uses grep to search throught itself (<code>$0</code>) for the marker and then it extracts the line number from the grep output and adds one to it.
This line number is then passed to tail preceded by a plus sign which causes tail to output everything starting at that line number.
The data is then fed directly into tar for extraction if the payload is binary. If it's uuencoded then it's first fed into uudecode before being fed into tar.</p>
<p>To create our installer let's use a simple payload file that contains three files name a, b, and c. We'll add the payload as an uuencoded block:</p>
<pre><code class="language-bash">$ sh addpayload.sh --uuencode abc.tar.gz
$ <span class="hljs-built_in">cat</span> install.sh
</code></pre>
<pre><code class="language-bash"><span class="hljs-comment">#/usr/bin/env bash</span>
<span class="hljs-comment"># install.sh creato da addpayload.sh</span>
... <span class="hljs-comment"># Installer script lines (see above)</span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;Install files? &quot;</span> ans
... <span class="hljs-comment"># More installer script lines (see above)</span>
<span class="hljs-built_in">exit</span> 0
PAYLOAD:
begin 644 -
M<span class="hljs-string">&#x27;XL(`))%G$D``^W12PJ$0`Q%T2REEI!HK%J/BM`]Z(F?_?O#J8+0&amp;=TS&quot;8&#x27;</span>`
M<span class="hljs-string">&quot;[Q6_D\WV7V?5AH]=COWBYB9%_4J:Q<span class="hljs-variable">$UK6J7I</span>`&amp;_R3+-[9B2_+YS_[F]&amp;\8I
JXJ%874#&amp;J_X;^H_0!V2\ZC_3/P```````````````/!D!0OB?_,`*```
`
end
</span></code></pre>
<p>At the end of the file you see the <code>PAYLOAD:</code> marker and the uuencoded block. If we now run the script we get:</p>
<pre><code class="language-bash">$ sh install.sh
Install files? y
-rw-r--r-- mitch/users 0 2009-02-18 11:29 a
-rw-r--r-- mitch/users 0 2009-02-18 11:29 b
-rw-r--r-- mitch/users 0 2009-02-18 11:29 c
</code></pre>
<p>I won't show you the <code>--binary</code> usage but it produces the same result, albeit with a slightly smaller foot print since the payload does not have to be uuencoded.</p>
</body></html>